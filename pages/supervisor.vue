<template>
  <Sidebar v-if="usuario && usuario.fotografia2" :foto="usuario.fotografia2" :title="usuario.nickname"
    :subtitle="usuario.email" :items="menuItems" @item-click="handleMenuClick">

    <div class="pa-6 text-center">
      <!-- Foto clickeable -->
      <v-avatar size="80" class="cursor-pointer" @click="dialogFoto = true">
        <v-img :src="usuario.fotografia2" alt="Foto de usuario" />
      </v-avatar>
      <h2 class="mt-4">Bienvenido {{ usuario.nickname }}</h2>
      <p>Entregas pendientes</p>
    </div>

    <!-- dasboard -->

    <div v-if="mostrardashboard" class="pa-6 text-center">
      <OrdenCard v-for="item in ordenes" :key="item.id_Orden" :orden="item" :usuarios="usuarios" />

    </div>

    <div v-if="mostrardashboardEntrega" class="pa-6 text-center">
      <OrdenCardEntrega v-for="item in ordenes" :key="item.id_Orden" :orden="item" />

    </div>

  </Sidebar>

  <!-- Dialog con la foto grande -->
  <v-dialog v-model="dialogFoto" max-width="500">
    <v-card>
      <v-img :src="usuario.fotografia2" alt="Foto en grande" />
      <v-card-actions class="justify-center">
        <v-btn color="primary" @click="dialogFoto = false">Cerrar</v-btn>
      </v-card-actions>
    </v-card>
  </v-dialog>

  <PiePagina />

  <dialogStatus v-model="dialogEvento" :loading="loadingEvento" :state="dialogState" :message="dialogMessage"
    :auto-close="cierre" />
</template>

<script setup>
import Sidebar from "../components/barraUser.vue"
import PiePagina from "../components/piePagina.vue"
import { ref, onMounted, onUnmounted } from "vue"
import { useRouter } from "vue-router"
import dialogStatus from "../components/dialogStatus.vue"
import { startConnection, on, connection } from "../utils/signalr";
import OrdenCard from "../components/cardDashAsigDomicilio.vue"
import { PendienteAsignarDomicilio, ordenPendienteEntrega } from "../utils/API_ordenes"
import OrdenCardEntrega from "../components/cardDashEntrega.vue"
import RegistroDialog from "../components/FromRegistroAdmin.vue"

const ordenes = ref([])
const usuarios = ref([])
const mostrardashboardEntrega = ref(false)

const itemSelect = ref("")



let connectionListener = null;

onMounted(async () => {
  // 👉 Define el listener
  connectionListener = async (payload) => {
    console.log("📡 Datos recibidos:", payload);

    if (itemSelect.value === "pendientesdomicilio") {
      const { ordenes: listaOrdenes, usuarios: listaUsuarios } = await PendienteAsignarDomicilio();

      // 🔹 Guardamos en los estados reactivos
      ordenes.value = listaOrdenes;
      usuarios.value = listaUsuarios;

    } else if (itemSelect.value === "pendientesmostrador") {
      ordenes.value = await ordenPendienteEntrega()

    }



  };

  // 👉 Registra el evento antes de conectar
  on("RecibirSaludo", connectionListener);

  // 👉 Inicia la conexión (espera a que esté lista)
  await startConnection();
});

onUnmounted(() => {
  try {
    if (connection?.off && connectionListener) {
      connection.off("RecibirSaludo", connectionListener);
      console.log("🧹 Listener eliminado correctamente");
    }
  } catch (err) {
    console.warn("⚠️ No se pudo eliminar el listener SignalR:", err);
  } finally {
    connectionListener = null;
  }
});

const cierre = ref()
const dialogEvento = ref(false)
const loadingEvento = ref(false)
const dialogState = ref("")
const dialogMessage = ref("")

onMounted(() => {
  if (process.client) {
    const usuarioGuardado = localStorage.getItem("usuario")
    if (usuarioGuardado) {
      usuario.value = JSON.parse(usuarioGuardado)

    }
  }
})


const router = useRouter()
const dialogFoto = ref(false)
const mostrardashboard = ref(false)


const menuItems = [
  { icon: "mdi-monitor-dashboard", title: "Ordenes domicilio", value: "pendientesdomicilio" },
  { icon: "mdi-monitor-dashboard", title: "Ordenes entrega tienda", value: "pendientesmostrador" },

  { icon: "mdi-login", title: "Salir", value: "exit" }
]

const usuario = ref({
  id: null,
  email: "",
  nickname: "",
  photo: ""
})


async function handleMenuClick(item) {
  if (item.value === "exit") {
    itemSelect.value = "exit"
    const sesion = useCookie("token")
    sesion.value = null
    localStorage.removeItem("usuario")
    router.push("/login")
  }
  else if (item.value === "pendientesdomicilio") {
    //conectar()
    itemSelect.value = "pendientesdomicilio"
    mostrardashboardEntrega.value = false;
    dialogEvento.value = true
    loadingEvento.value = true
    dialogState.value = ""
    dialogMessage.value = ""

    const { ordenes: listaOrdenes, usuarios: listaUsuarios } = await PendienteAsignarDomicilio();

    // 🔹 Guardamos en los estados reactivos
    ordenes.value = listaOrdenes;
    usuarios.value = listaUsuarios;

    if (Array.isArray(ordenes.value) && ordenes.value.length > 0) {
      loadingEvento.value = false;
      dialogState.value = "success";
      dialogMessage.value = "Órdenes encontradas: " + ordenes.value.length;
      cierre.value = 2000;
      mostrardashboard.value = true;
    } else {
      loadingEvento.value = false;
      dialogState.value = "error";
      dialogMessage.value = "No tiene órdenes";
      cierre.value = 2000;
      mostrardashboard.value = false;
    }

  } else if (item.value === "pendientesmostrador") {
    //conectar()
    itemSelect.value = "pendientesmostrador"
    mostrardashboard.value = false;
    dialogEvento.value = true
    loadingEvento.value = true
    dialogState.value = ""
    dialogMessage.value = ""

    ordenes.value = await ordenPendienteEntrega()

    if (Array.isArray(ordenes.value) && ordenes.value.length > 0) {
      loadingEvento.value = false;
      dialogState.value = "success";
      dialogMessage.value = "Órdenes encontradas: " + ordenes.value.length;
      cierre.value = 2000;
      mostrardashboardEntrega.value = true;
    } else {
      loadingEvento.value = false;
      dialogState.value = "error";
      dialogMessage.value = "No tiene órdenes";
      cierre.value = 2000;
      mostrardashboardEntrega.value = false;
    }

  } else {

    loadingEvento.value = false;
    dialogState.value = "error";
    dialogMessage.value = "Error en seleccion de opcion";
    cierre.value = 2000;
    mostrardashboardEntrega.value = false;
    mostrardashboard.value = false;
  }
}

</script>
